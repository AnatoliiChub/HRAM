name: Pull Request
run-name: Running pre-merge pull request tasks

on:
  pull_request:
    branches:
      - main

# Cancel in-progress runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Static code analysis
  detekt:
    name: Static Code Analysis
    uses: ./.github/workflows/detekt-analysis.yml

  # Unit tests and coverage
  unit-tests:
    name: Unit Tests & Coverage
    uses: ./.github/workflows/unit-tests.yml
    permissions:
      contents: read
      pull-requests: write

  # Android debug build
  android-build:
    name: Android Build
    needs: [detekt]
    uses: ./.github/workflows/android-build.yml

  # iOS debug build
  ios-build:
    name: iOS Build
    needs: [detekt]
    uses: ./.github/workflows/ios-build.yml

  # Summary comment on PR
  summary:
    name: Post PR Summary
    needs: [detekt, unit-tests, android-build, ios-build]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: always()

    steps:
      - name: Generate PR summary comment
        uses: mshick/add-pr-comment@v2
        with:
          message: |
            ## ğŸš€ Pull Request Build Summary
            
            All pre-merge checks have completed. Review the results below:
            
            ### ğŸ“Š Reports & Artifacts
            
            | Check | Status | Artifact |
            |-------|--------|----------|
            | ğŸ” Detekt Analysis | ${{ needs.detekt.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | [View Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ needs.detekt.outputs.artifact-id }}) |
            | ğŸ§ª Unit Tests & Coverage | ${{ needs.unit-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | [View Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ needs.unit-tests.outputs.artifact-id }}) |
            | ğŸ¤– Android Debug Build | ${{ needs.android-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | [Download APK](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ needs.android-build.outputs.artifact-id }}) |
            | ğŸ iOS Debug Build | ${{ needs.ios-build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} | [Download App](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${{ needs.ios-build.outputs.artifact-id }}) |
            
            ---
            *Workflow run: [#${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
